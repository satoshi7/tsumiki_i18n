# 3.3 テストケース作成

## テストケース作成の重要性

AITDDにおいて、テストケースは実装の品質を決定する重要な要素です。AIが生成するコードの品質は、テストケースの網羅性と精度に大きく依存するため、この段階で包括的なテストケースを設計することが重要です。

## テストケース設計の原則

### 1. 網羅性の確保

#### 機能の網羅性
- **正常系**: 期待される動作すべて
- **異常系**: エラー処理とバリデーション
- **境界値**: 入力値の境界条件
- **エッジケース**: 特殊な条件や例外的な状況

#### テストレベルの網羅性
- **単体テスト**: 個別関数・メソッドのテスト
- **統合テスト**: コンポーネント間の連携テスト
- **エンドツーエンドテスト**: ユーザーシナリオの完全実行

### 2. 明確で具体的な期待値

```markdown
❌ 悪い例：「エラーが発生すること」
✅ 良い例：「ステータスコード400とエラーメッセージ"Email already exists"が返却されること」
```

### 3. 独立性と再現性
- 各テストケースは独立して実行可能
- テスト実行順序に依存しない
- 外部環境に依存しない

## テストケース文書の標準フォーマット

### 基本テンプレート

```markdown
# [機能名] テストケース仕様書

## テスト概要
- **対象機能**: テスト対象の機能名
- **テスト目的**: 何を検証するか
- **前提条件**: テスト実行の前提

## テストケース一覧

### TC001: [テストケース名]
- **分類**: 正常系/異常系/境界値
- **目的**: このテストで検証する内容
- **前提条件**: テスト実行前の状態
- **テストデータ**: 入力データの詳細
- **実行手順**: 
  1. 具体的な手順1
  2. 具体的な手順2
- **期待結果**: 
  - 期待される動作の詳細
  - 期待される出力値
- **事後条件**: テスト実行後の期待される状態
```

### 具体的なテストケース例

#### 例：ユーザー登録機能のテストケース

```markdown
# ユーザー登録機能 テストケース仕様書

## テスト概要
- **対象機能**: ユーザー新規登録API (POST /api/users)
- **テスト目的**: 新規ユーザー登録の全パターンを検証
- **前提条件**: データベースが初期状態、APIサーバーが稼働中

## テストケース一覧

### TC001: 正常なユーザー登録
- **分類**: 正常系
- **目的**: 有効なデータでの新規ユーザー登録を検証
- **前提条件**: test@example.com は未登録
- **テストデータ**: 
  ```json
  {
    "email": "test@example.com",
    "password": "SecurePass123!",
    "password_confirmation": "SecurePass123!"
  }
  ```
- **実行手順**: 
  1. POST /api/users にテストデータを送信
  2. レスポンスを確認
  3. データベースの状態を確認
- **期待結果**: 
  - ステータスコード: 201
  - レスポンス: 
    ```json
    {
      "id": 任意の正整数,
      "email": "test@example.com",
      "created_at": "日時（ISO8601形式）"
    }
    ```
  - データベース: usersテーブルに新しいレコードが作成される
  - パスワードがハッシュ化されて保存される
- **事後条件**: ユーザーが正常に登録され、ログイン可能

### TC002: メールアドレス重複エラー
- **分類**: 異常系
- **目的**: 既存メールアドレスでの登録時のエラー処理を検証
- **前提条件**: test@example.com が既に登録済み
- **テストデータ**: 
  ```json
  {
    "email": "test@example.com",
    "password": "AnotherPass456!",
    "password_confirmation": "AnotherPass456!"
  }
  ```
- **実行手順**: 
  1. POST /api/users にテストデータを送信
  2. レスポンスを確認
  3. データベースの状態を確認
- **期待結果**: 
  - ステータスコード: 400
  - レスポンス: 
    ```json
    {
      "error": "validation_failed",
      "details": [
        {
          "field": "email",
          "message": "Email already exists"
        }
      ]
    }
    ```
  - データベース: 新しいレコードは作成されない
- **事後条件**: 既存ユーザーデータに影響なし

### TC003: パスワード不一致エラー
- **分類**: 異常系
- **目的**: パスワードと確認パスワードの不一致時のエラー処理を検証
- **前提条件**: 新規メールアドレスを使用
- **テストデータ**: 
  ```json
  {
    "email": "new@example.com",
    "password": "SecurePass123!",
    "password_confirmation": "DifferentPass456!"
  }
  ```
- **期待結果**: 
  - ステータスコード: 400
  - エラーメッセージ: "Password confirmation does not match"

### TC004: 無効なメールアドレス形式
- **分類**: 異常系・境界値
- **目的**: メールアドレス形式バリデーションを検証
- **テストデータ集**:
  - "invalid-email" (@ がない)
  - "test@" (ドメイン部がない)
  - "@example.com" (ローカル部がない)
  - "test..test@example.com" (連続ドット)
- **期待結果**: すべて400エラーとなること

### TC005: パスワード強度不足
- **分類**: 異常系・境界値
- **目的**: パスワード強度バリデーションを検証
- **テストデータ集**:
  - "short" (8文字未満)
  - "onlylowercase" (小文字のみ)
  - "ONLYUPPERCASE" (大文字のみ)
  - "12345678" (数字のみ)
  - "NoSymbol123" (記号なし)
- **期待結果**: すべて400エラーとなること

### TC006: 必須項目未入力
- **分類**: 異常系
- **目的**: 必須項目のバリデーションを検証
- **テストデータ集**:
  - email なし
  - password なし
  - password_confirmation なし
  - 空文字列のケース
  - null のケース
- **期待結果**: すべて400エラーとなること

### TC007: 境界値テスト - メールアドレス長
- **分類**: 境界値
- **目的**: メールアドレスの文字数制限を検証
- **テストデータ**:
  - 254文字（最大許可）
  - 255文字（制限超過）
- **期待結果**: 
  - 254文字: 正常登録
  - 255文字: 400エラー

### TC008: レート制限テスト
- **分類**: 非機能
- **目的**: 同時登録のレート制限を検証
- **実行手順**: 短時間で大量のリクエストを送信
- **期待結果**: 制限を超えた場合429エラー

### TC009: データベース接続エラー
- **分類**: 異常系・インフラ
- **目的**: データベース障害時の動作を検証
- **前提条件**: データベースが利用不可
- **期待結果**: 500エラーとエラーログ出力

### TC010: CSRFトークン検証
- **分類**: セキュリティ
- **目的**: CSRF攻撃の防止を検証
- **テストデータ**: CSRFトークンなし、または無効なトークン
- **期待結果**: 403エラー
```

## テストケース作成のワークフロー

### 1. 仕様書からのテストケース抽出

```markdown
仕様書の各項目 → 対応するテストケース

■ 機能要件
- 基本機能 → 正常系テストケース
- バリデーション → 異常系テストケース
- 入力制限 → 境界値テストケース

■ 非機能要件
- パフォーマンス → 負荷テストケース
- セキュリティ → セキュリティテストケース
- 可用性 → 障害テストケース
```

### 2. テストケース設計の手順

#### ステップ1: テスト観点の整理
```markdown
## テスト観点一覧

### 機能観点
- [ ] 正常な入力での動作
- [ ] 入力値バリデーション
- [ ] エラーハンドリング
- [ ] データ永続化

### データ観点
- [ ] 境界値（最小、最大）
- [ ] 特殊文字・多言語
- [ ] NULL・空文字
- [ ] 不正な形式

### 状態観点
- [ ] 初期状態
- [ ] データ存在状態
- [ ] エラー状態
- [ ] 制限状態

### 環境観点
- [ ] 正常環境
- [ ] 高負荷環境
- [ ] 障害環境
```

#### ステップ2: テストケースマトリックス作成

| 機能 | 正常系 | 異常系 | 境界値 | セキュリティ | パフォーマンス |
|------|--------|--------|--------|--------------|----------------|
| ユーザー登録 | TC001 | TC002-006 | TC007 | TC010 | TC008 |
| バリデーション | - | TC002-006 | TC004,005,007 | - | - |
| データ保存 | TC001 | TC009 | - | - | - |

#### ステップ3: 詳細テストケース作成
- 各セルの内容を詳細なテストケースとして展開
- 実行可能な具体的手順に落とし込み
- 期待結果を明確に定義

### 3. AI活用によるテストケース支援

#### AIを活用できる領域
- **網羅性チェック**: 漏れているテストケースの指摘
- **テストデータ生成**: 境界値や異常値の提案
- **期待値計算**: 複雑な計算結果の算出
- **テストケース構造化**: フォーマットの統一

#### 人間が判断すべき領域
- **ビジネス要件の理解**: ドメイン固有の要件
- **リスク評価**: 影響度と重要度の判定
- **テスト優先度**: 実行順序とリソース配分
- **品質基準**: 受け入れ基準の設定

## テストケース品質のチェックポイント

### 1. 完全性の確認

#### 機能カバレッジ
```markdown
## カバレッジチェックリスト

### API仕様書の各項目
- [ ] 全エンドポイントにテストケースあり
- [ ] 全パラメータにテストケースあり
- [ ] 全レスポンスパターンにテストケースあり

### エラーハンドリング
- [ ] 全エラーコードにテストケースあり
- [ ] 全バリデーションルールにテストケースあり
- [ ] 全例外パターンにテストケースあり
```

#### ビジネスルールカバレッジ
```markdown
### ビジネスルール検証
- [ ] 全業務フローにテストケースあり
- [ ] 全業務例外にテストケースあり
- [ ] 全権限パターンにテストケースあり
```

### 2. 実行可能性の確認

#### テストデータの準備可能性
- 必要なテストデータが準備可能か
- 外部依存サービスのモック化が可能か
- テスト環境での実行が可能か

#### 期待結果の検証可能性
- 期待結果が客観的に判定可能か
- 検証に必要なツールや方法が利用可能か
- 自動化が困難な部分の手動確認方法

### 3. 保守性の確認

#### テストケースの独立性
- 各テストケースが独立して実行可能
- テスト順序に依存しない
- 並列実行が可能

#### 変更への対応
- 仕様変更時の影響範囲が明確
- テストケースの修正が容易
- テストデータの管理が簡単

## 人間レビューのポイント

### レビュー観点

#### 1. ビジネス要件との整合性
- [ ] ユーザーストーリーが適切にテストされているか
- [ ] ビジネスルールが正しく反映されているか
- [ ] エッジケースが業務観点で妥当か

#### 2. リスクベースの優先度
- [ ] 高リスク機能に十分なテストケースがあるか
- [ ] 重要な業務フローが網羅されているか
- [ ] セキュリティ要件が適切にテストされているか

#### 3. テスト効率性
- [ ] テストケース数が適切か（過多/過少でない）
- [ ] 重複するテストケースがないか
- [ ] 自動化可能な部分と手動テストの分離が適切か

### レビュープロセス

#### ステップ1: 初期レビュー
- 仕様書との整合性確認
- 網羅性の基本チェック
- 明らかな漏れや問題の指摘

#### ステップ2: 詳細レビュー
- 各テストケースの妥当性確認
- 期待結果の正確性確認
- 実行可能性の検証

#### ステップ3: 最終承認
- 全体的な品質確認
- テスト実行計画の確認
- 次フェーズへの進行判定

## テストケース作成のベストプラクティス

### 1. 段階的詳細化

```markdown
第1段階: 概要レベル
「ユーザー登録の正常系・異常系をテストする」

第2段階: 機能レベル
「有効データでの登録成功」
「無効データでの登録失敗」

第3段階: 詳細レベル
「TC001: 正常なユーザー登録」
「TC002: メールアドレス重複エラー」
```

### 2. テストデータの戦略的設計

#### データパターンの体系化
```markdown
## 基本データセット
- 正常データ: 一般的な有効値
- 境界データ: 制限値（最小/最大）
- 異常データ: 無効値・不正値
- 特殊データ: 特殊文字・多言語・NULL
```

#### 再利用可能なテストデータ
- 共通的に使用するテストデータの定義
- テストデータのバリエーション管理
- データ作成の自動化

### 3. 期待結果の精密な定義

#### 具体的な期待値
```markdown
❌ 「エラーになること」
✅ 「HTTP 400 + {"error": "validation_failed", "field": "email"}」

❌ 「正常に登録されること」
✅ 「HTTP 201 + ユーザーID返却 + DBにレコード作成」
```

#### 検証可能な条件
- 出力値の具体的な値や形式
- データベースの状態変化
- ログ出力の内容
- 外部システムへの影響

## よくある問題と対策

### 問題1: テストケースの粒度が不適切

**症状**: 
- 1つのテストケースで複数の機能をテスト
- 逆に細かすぎて管理コストが高い

**対策**: 
- 1つのテストケース = 1つの検証観点
- ビジネス価値のある単位でグループ化

### 問題2: 期待結果が曖昧

**症状**: 
- 「正常に動作する」「エラーが発生する」など
- 判定基準が不明確

**対策**: 
- 具体的な値や状態を明記
- 自動テストでの判定条件を意識

### 問題3: テストケースの漏れ

**症状**: 
- エッジケースが未考慮
- エラーパターンの不足

**対策**: 
- チェックリストによる体系的確認
- 同等クラス分割や境界値分析の活用

### 問題4: 保守性の不足

**症状**: 
- 仕様変更時にテストケース修正が困難
- テストデータの管理が煩雑

**対策**: 
- モジュール化された設計
- 再利用可能なテストデータ設計

## 次のステップへの準備

テストケース作成が完了したら、次は[Red-Green-Refactor-Validationサイクル](./04-rgr-validation-cycle.md)に進みます。

### 成果物の確認
- [ ] testcases.md が詳細に作成されている
- [ ] 全ての仕様項目にテストケースが対応している
- [ ] 期待結果が具体的に定義されている
- [ ] 人間によるレビューが完了している
- [ ] テストデータが準備可能である

### 品質チェックリスト
- [ ] **網羅性**: 正常系・異常系・境界値がカバーされている
- [ ] **明確性**: 期待結果が具体的で検証可能
- [ ] **独立性**: 各テストケースが独立して実行可能
- [ ] **実現性**: テスト環境で実行可能
- [ ] **保守性**: 仕様変更に対応しやすい構造

適切なテストケース作成により、AIが高品質なコードを生成するための基盤が整います。次の章では、これらのテストケースを基にした実装サイクルを詳しく解説します。