# 5.1 効果的なプロンプト設計の原則

## はじめに

AITDDにおいて、AIの出力品質はプロンプト設計に大きく依存します。適切なプロンプト設計により、AI生成コードの品質向上と開発効率の最大化を実現できます。本章では、実践的なプロンプト設計の原則と具体的な手法を学びます。

## プロンプト設計の基本原則

### 1. 反復改善方式の採用

AITDDでは、一度のプロンプト作成で完璧な結果を求めるのではなく、継続的な改善を前提とした設計を行います。

**基本サイクル：**
```
プロンプト作成 → 実行 → 結果評価 → 修正 → 再実行
```

**実践のポイント：**
- 初回は80%の品質を目標とし、完璧を求めない
- 各実行結果を詳細に分析し、改善点を特定
- 小さな修正を積み重ねて最適化を図る
- 改善ログを記録し、パターンを把握

### 2. 確信度評価の組み込み

AIに自身の出力に対する確信度を評価させることで、レビューすべき箇所を効率的に特定できます。

**確信度の指標：**
- **🟢 高確信度**: 参照ファイルから明確に導出可能
- **🟡 中確信度**: 合理的推測に基づくが確認が必要
- **🔴 要判断**: 独自判断による生成で重点確認が必要

### 3. ステップ別カスタマイズ

TDDの各ステップ（Red、Green、Refactor、Validation）ごとに、プロンプトを最適化します。

**ステップ別の特徴：**
- **Red**: テスト作成の明確性と網羅性を重視
- **Green**: 最小実装と意図しない変更の防止
- **Refactor**: 品質向上と機能保持のバランス
- **Validation**: 総合的な品質チェックと課題発見

## AITDDにおけるプロンプトパターン

### パターン1: TODO記録指示

AI生成結果の確認すべき項目をTODO形式で記録させるパターンです。

**基本テンプレート：**
```markdown
## プロンプトでの指示例

以下の処理を実行し、結果をTODOリストとして記録してください：

**実行内容：**
[具体的な指示内容]

**TODO記録フォーマット：**
```markdown
## [ステップ名]結果TODO

### 🟢 高確信度項目
- [ ] [ファイル名](相対パス) の具体的確認内容

### 🟡 中確信度項目  
- [ ] [ファイル名](相対パス) の推定内容の妥当性確認

### 🔴 要判断項目
- [ ] 詳細確認: [ファイル名](相対パス) の組織固有内容
```

**参照ファイル：** [指定するファイルのリスト]
**出力ファイル：** `./todos/[ステップ名]-check.md`
```

### パターン2: 確信度評価指示

AI生成内容の根拠と確信度を明示させるパターンです。

**基本テンプレート：**
```markdown
## 確信度評価指示

各生成内容について、以下の基準で確信度を評価してください：

**評価基準：**
- 🟢 青信号：参照ファイルから明確に推測可能
- 🟡 黄信号：合理的推測だが要確認
- 🔴 赤信号：独自判断による生成

**評価対象：**
1. 生成したコードの各機能
2. テストケースの選択理由
3. 実装方針の決定根拠

**出力形式：**
- 各項目に信号機マークを付与
- 根拠となる参照ファイルの箇所を明記
- 推測理由を簡潔に説明
```

### パターン3: 段階的詳細化指示

複雑な実装を段階的に進めるためのパターンです。

**基本テンプレート：**
```markdown
## 段階的実装指示

以下の順序で段階的に実装を進めてください：

**Phase 1: 基本構造**
- 最小限の動作確認
- 主要な関数・クラスの骨格
- 基本的なテストケース

**Phase 2: 機能拡張**
- 具体的な機能実装
- エラーハンドリング
- 追加テストケース

**Phase 3: 最適化**
- パフォーマンス改善
- コード品質向上
- 総合テスト

**各フェーズ後の確認：**
- テスト実行結果の報告
- 確信度評価の実施
- 次フェーズへの課題整理
```

## 実践的なプロンプト構成要素

### 必須要素チェックリスト

プロンプト作成時に必ず含めるべき要素：

- [ ] **明確な目的の定義**
  - 何を実現したいかの明確な説明
  - 期待する出力の具体的な形式

- [ ] **参照ファイルの指定**
  - 根拠とすべきファイルの明記
  - ファイル間の関係性の説明

- [ ] **確信度評価の指示**
  - 信号機システムの適用指示
  - 評価基準の明確な定義

- [ ] **出力形式の指定**
  - ファイル名と保存場所の指定
  - マークダウン形式等の詳細指定

- [ ] **制約・注意事項の明記**
  - 変更してはいけない箇所
  - 特別な考慮事項

### テンプレート化可能な部分

**標準ヘッダー例：**
```markdown
## [ステップ名] 実行指示

**目的：** [具体的な目的]
**参照ファイル：** [ファイルリスト]
**出力ファイル：** [保存先パス]

**確信度評価：**
各生成内容について🟢🟡🔴で確信度を表示

**制約事項：**
- [重要な制約事項]
```

### カスタマイズが必要な部分

プロジェクト固有でカスタマイズすべき要素：

1. **ドメイン固有の用語・概念**
   - 業界特有の用語の定義
   - プロジェクト内での命名規則

2. **技術スタック固有の制約**
   - 使用フレームワークの制約
   - パフォーマンス要件

3. **組織固有のルール**
   - コーディング規約
   - セキュリティガイドライン

## 品質確保のためのプロンプト技法

### 1. 想定外実装の防止

**対策技法：**
```markdown
## 実装制約の明確化

**変更許可範囲：**
- 変更可能：[具体的なファイル・関数名]
- 変更禁止：[既存の動作している部分]

**実装方針：**
- 最小限の変更で目的を達成
- 既存機能への影響を最小化
- 新規追加を基本とし、既存修正は最小限

**確認チェック：**
- [ ] 指定範囲外の変更が含まれていないか
- [ ] 既存テストが引き続き成功するか
- [ ] 意図しない副作用が発生していないか
```

### 2. 参照元ファイルとの関係性明示

**関係性明示の例：**
```markdown
## 参照ファイル関係図

**主要参照：**
- `spec.md` → 要件定義の根拠
- `existing_test.js` → 既存仕様の確認
- `config.json` → 設定仕様の参照

**派生参照：**
- `utils.js` → 既存ユーティリティの活用
- `types.ts` → 型定義の整合性確保

**生成時の参照優先度：**
1. 主要参照を最優先
2. 矛盾する内容は主要参照を採用
3. 不明な点は明確に質問として記録
```

### 3. 段階的詳細化の実装

**詳細化戦略：**
```markdown
## 段階的詳細化プロセス

**Level 1: 骨格作成**
- インターフェース定義
- 主要関数のシグネチャ
- 基本的なエラーハンドリング

**Level 2: 機能実装**
- ビジネスロジックの実装
- 詳細なエラーハンドリング
- 入力値検証

**Level 3: 最適化・完成**
- パフォーマンス最適化
- エッジケース対応
- ドキュメント整備

**各レベルでの確認項目：**
- テスト実行結果
- 確信度評価
- 次レベルでの課題
```

## 実践演習

### 演習1: 基本プロンプトの作成

以下のシナリオでプロンプトを作成してください：

**シナリオ：** ユーザー認証機能のテストケース作成
**参照ファイル：** `auth_spec.md`, `user_model.js`
**期待する出力：** Jest形式のテストファイル

**作成すべき要素：**
1. 明確な目的定義
2. 参照ファイルの指定
3. 確信度評価の指示
4. 出力形式の指定

### 演習2: 段階的実装プロンプトの設計

**シナリオ：** REST API エンドポイントの実装
**要件：** 複雑なデータ処理を含む
**制約：** 既存のミドルウェアを活用

**設計すべき要素：**
1. 3段階の実装フェーズ
2. 各フェーズの成果物
3. フェーズ間の確認項目

## まとめ

効果的なプロンプト設計の核心は以下の通りです：

1. **反復改善**: 一度で完璧を求めず、継続的な改善を前提とする
2. **確信度評価**: AIの推測部分を可視化し、効率的なレビューを実現
3. **ステップ別最適化**: TDDの各段階に応じたプロンプト設計
4. **品質制御**: 想定外実装の防止と参照元の明確化

次のセクションでは、これらの原則を具体的に活用するAI推論の可視化技術について詳しく学習します。
